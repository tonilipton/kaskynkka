---
import { getSupabaseClient } from '../../lib/supabaseClient'

let orders: any[] = []
let error: string | null = null

try {
  const supabase = getSupabaseClient()
  const { data, error: fetchError } = await supabase
    .from('orders')
    .select('*')
    .order('created_at', { ascending: false })
    .limit(50)
  
  if (fetchError) {
    error = fetchError.message
  } else {
    orders = data || []
    
    // Fetch order items for each order
    for (const order of orders) {
      const { data: items } = await supabase
        .from('order_items')
        .select('*, menu_items(*)')
        .eq('order_id', order.id)
      
      order.items = items || []
    }
  }
} catch (e: any) {
  error = e.message || 'Failed to load orders'
}
---

<!DOCTYPE html>
<html lang="fi" class="bg-dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Orders - Ravintola Käskynkkä</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script is:inline>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              dark: '#121212',
              surface: '#1E1E1E',
              accent: '#C4A484',
              light: '#F5F5F5',
              muted: '#A3A3A3',
            },
            fontFamily: {
              serif: ['"Cormorant Garamond"', 'serif'],
              sans: ['Inter', 'sans-serif'],
            }
          }
        }
      }
    </script>
  </head>
  <body class="bg-dark text-light font-sans min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">
      <!-- Header -->
      <header class="flex justify-between items-center mb-8 pb-6 border-b border-dark">
        <div>
          <h1 class="font-serif text-3xl text-accent uppercase tracking-ultra">Order Management</h1>
          <p class="text-muted mt-1">Manage incoming orders and update status</p>
        </div>
        <div class="flex gap-4">
          <a 
            href="/admin/menu" 
            class="px-4 py-2 border border-accent text-accent hover:bg-accent hover:text-dark transition-colors font-sans uppercase tracking-wider text-sm"
          >
            Menu Management
          </a>
          <a 
            href="/" 
            class="px-4 py-2 bg-accent text-dark hover:bg-accent/90 transition-colors font-sans uppercase tracking-wider text-sm"
          >
            Back to Site
          </a>
        </div>
      </header>
      
      {error ? (
        <div class="bg-red-900/30 border border-red-500/50 text-red-200 p-4 mb-6">
          <p>Error loading orders: {error}</p>
        </div>
      ) : orders.length === 0 ? (
        <div class="text-center py-16 bg-surface border border-dark">
          <p class="text-muted text-lg">No orders yet</p>
          <p class="text-muted/60 text-sm mt-2">New orders will appear here when customers place them</p>
        </div>
      ) : (
        <div class="space-y-6">
          {orders.map((order) => (
            <div class="bg-surface border border-dark p-6" data-order-id={order.order_id}>
              <!-- Order Header -->
              <div class="flex justify-between items-start mb-4 pb-4 border-b border-dark">
                <div>
                  <h3 class="font-serif text-xl text-accent">Order #{order.order_id}</h3>
                  <p class="text-muted text-sm mt-1">
                    {order.customer_name || 'Guest'} • {new Date(order.created_at).toLocaleString('fi-FI')}
                  </p>
                </div>
                <div class={`
                  px-4 py-2 font-sans uppercase tracking-wider text-xs font-bold
                  ${order.status === 'Pending' ? 'bg-yellow-900/30 text-yellow-400 border border-yellow-500/30' : ''}
                  ${order.status === 'Confirmed' ? 'bg-blue-900/30 text-blue-400 border border-blue-500/30' : ''}
                  ${order.status === 'Ready' ? 'bg-green-900/30 text-green-400 border border-green-500/30' : ''}
                `}>
                  {order.status}
                </div>
              </div>
              
              <!-- Order Items -->
              <div class="mb-4">
                <h4 class="font-sans uppercase tracking-wider text-xs text-muted mb-3">Items</h4>
                <ul class="space-y-2">
                  {order.items && order.items.length > 0 ? (
                    order.items.map((item: any) => (
                      <li class="flex justify-between text-light">
                        <span>
                          <span class="font-medium">{item.menu_items?.title || 'Unknown'}</span>
                          <span class="text-muted text-sm ml-2">× {item.quantity}</span>
                        </span>
                        <span class="text-accent">€{(item.price * item.quantity).toFixed(2)}</span>
                      </li>
                    ))
                  ) : (
                    <li class="text-muted italic">No items found</li>
                  )}
                </ul>
              </div>
              
              <!-- Order Footer -->
              <div class="flex justify-between items-center pt-4 border-t border-dark">
                <div>
                  <p class="text-accent font-serif text-xl">€{order.total.toFixed(2)}</p>
                  {order.estimated_time && (
                    <p class="text-muted text-sm mt-1">Est. ready in {order.estimated_time} minutes</p>
                  )}
                </div>
                
                <div class="flex gap-3">
                  {order.status === 'Pending' && (
                    <>
                      <button 
                        class="px-4 py-2 bg-blue-900/50 border border-blue-500/50 text-blue-200 hover:bg-blue-800/50 transition-colors font-sans uppercase tracking-wider text-xs"
                        data-action="accept"
                        data-time="20"
                        data-order-id={order.order_id}
                      >
                        20 min
                      </button>
                      <button 
                        class="px-4 py-2 bg-blue-900/50 border border-blue-500/50 text-blue-200 hover:bg-blue-800/50 transition-colors font-sans uppercase tracking-wider text-xs"
                        data-action="accept"
                        data-time="30"
                        data-order-id={order.order_id}
                      >
                        30 min
                      </button>
                      <button 
                        class="px-4 py-2 bg-blue-900/50 border border-blue-500/50 text-blue-200 hover:bg-blue-800/50 transition-colors font-sans uppercase tracking-wider text-xs"
                        data-action="accept"
                        data-time="40"
                        data-order-id={order.order_id}
                      >
                        40 min
                      </button>
                    </>
                  )}
                  
                  {order.status === 'Confirmed' && (
                    <button 
                      class="px-4 py-2 bg-green-900/50 border border-green-500/50 text-green-200 hover:bg-green-800/50 transition-colors font-sans uppercase tracking-wider text-xs"
                      data-action="ready"
                      data-order-id={order.order_id}
                    >
                      Mark Ready
                    </button>
                  )}
                  
                  {order.status === 'Ready' && (
                    <span class="text-green-400 font-sans uppercase tracking-wider text-sm flex items-center gap-2">
                      <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                      </svg>
                      Ready for Pickup
                    </span>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  </body>
</html>

<script>
  async function updateOrder(orderId: string, status: string, estimatedTime?: number) {
    try {
      const response = await fetch('/api/update-order-status', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          orderId,
          status,
          estimatedTime,
        }),
      })
      
      const data = await response.json()
      
      if (!response.ok) {
        throw new Error(data.error || 'Failed to update order')
      }
      
      // Reload page to show updated status
      window.location.reload()
    } catch (error: any) {
      alert(`Error: ${error.message}`)
      console.error('Error updating order:', error)
    }
  }
  
  document.querySelectorAll('[data-action]').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const target = e.target as HTMLElement
      const action = target.getAttribute('data-action')
      const orderId = target.getAttribute('data-order-id')
      const time = target.getAttribute('data-time')
      
      if (!orderId) return
      
      if (action === 'accept' && time) {
        if (confirm(`Accept order and set estimated time to ${time} minutes?`)) {
          await updateOrder(orderId, 'Confirmed', parseInt(time))
        }
      } else if (action === 'ready') {
        if (confirm('Mark this order as ready for pickup?')) {
          await updateOrder(orderId, 'Ready')
        }
      }
    })
  })
</script>
