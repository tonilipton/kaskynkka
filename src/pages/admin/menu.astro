---
import { getSupabaseClient } from '../../lib/supabaseClient'

let menuItems: any[] = []
let categories: string[] = []
let error: string | null = null
let successMessage: string | null = null

// Get action from URL
const action = Astro.url.searchParams.get('action')
const editId = Astro.url.searchParams.get('edit')

// Handle form submissions
if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    const supabase = getSupabaseClient();

    const formAction = formData.get('action');

    if (formAction === 'create' || formAction === 'update') {
      const itemData = {
        title: formData.get('title'),
        description: formData.get('description'),
        price: parseFloat(formData.get('price')),
        category: formData.get('category'),
        sold_out: formData.get('sold_out') === 'on'
      };

      const siteUrl = import.meta.env.PUBLIC_SITE_URL || 'https://kaskynkka.net';
      const imageFile = formData.get('imageFile');
      if (imageFile && imageFile instanceof File) {
        const { data: uploadData, error: uploadError } = await supabase.storage
          .from('menu-images')
          .upload(`menu/${imageFile.name}`, imageFile, { upsert: true });
        if (uploadError) throw uploadError;
        itemData.image = `${siteUrl}${uploadData.path}`;
      } else if (formData.get('image')) {
        itemData.image = formData.get('image');
      }

      if (formAction === 'create') {
        const { error: insertError } = await supabase
          .from('menu_items')
          .insert([itemData]);
        if (insertError) throw insertError;
        successMessage = 'Menu item created successfully!';
      } else {
        const id = formData.get('id');
        const { error: updateError } = await supabase
          .from('menu_items')
          .update(itemData)
          .eq('id', id);
        if (updateError) throw updateError;
        successMessage = 'Menu item updated successfully!';
      }
    } else if (formAction === 'delete') {
      const id = formData.get('id');
      const { error: deleteError } = await supabase
        .from('menu_items')
        .delete()
        .eq('id', id);
      if (deleteError) throw deleteError;
      successMessage = 'Menu item deleted successfully!';
    }
  } catch (e) {
    error = e.message || 'Failed to process request';
  }
}

      if (formAction === 'create') {
        const { error: insertError } = await supabase
          .from('menu_items')
          .insert([itemData]);
        if (insertError) throw insertError;
        successMessage = 'Menu item created successfully!';
      } else {
        const id = formData.get('id') as string;
        const { error: updateError } = await supabase
          .from('menu_items')
          .update(itemData)
          .eq('id', id);
        if (updateError) throw updateError;
        successMessage = 'Menu item updated successfully!';
      }
    } else if (formAction === 'delete') {
      const id = formData.get('id') as string;
      const { error: deleteError } = await supabase
        .from('menu_items')
        .delete()
        .eq('id', id);
      if (deleteError) throw deleteError;
      successMessage = 'Menu item deleted successfully!';
    }
  } catch (e: any) {
    error = e.message || 'Failed to process request';
  }
}


// Fetch menu items and categories
try {
  const supabase = getSupabaseClient()
  const { data: items, error: fetchError } = await supabase
    .from('menu_items')
    .select('*')
    .order('category', { ascending: true })
    .order('title', { ascending: true })
  
  if (fetchError) {
    error = fetchError.message
  } else {
    menuItems = items || []
    // Extract unique categories
    categories = [...new Set(menuItems.map(item => item.category).filter(Boolean))]
  }
} catch (e: any) {
  error = e.message || 'Failed to load menu items'
}

// Get item to edit if editing
let editItem = null
if (editId) {
  editItem = menuItems.find(item => item.id === editId)
}
---

<!DOCTYPE html>
<html lang="fi" class="bg-dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Menu Management - Ravintola Käskynkkä</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script is:inline>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              dark: '#121212',
              surface: '#1E1E1E',
              accent: '#C4A484',
              light: '#F5F5F5',
              muted: '#A3A3A3',
            },
            fontFamily: {
              serif: ['"Cormorant Garamond"', 'serif'],
              sans: ['Inter', 'sans-serif'],
            }
          }
        }
      }
    </script>
  </head>
  <body class="bg-dark text-light font-sans min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">
      <!-- Header -->
      <header class="flex justify-between items-center mb-8 pb-6 border-b border-dark">
        <div>
          <h1 class="font-serif text-3xl text-accent uppercase tracking-ultra">Menu Management</h1>
          <p class="text-muted mt-1">Add, edit, or remove menu items</p>
        </div>
        <div class="flex gap-4">
          <a 
            href="/admin/orders" 
            class="px-4 py-2 border border-accent text-accent hover:bg-accent hover:text-dark transition-colors font-sans uppercase tracking-wider text-sm"
          >
            Order Management
          </a>
          <a 
            href="/" 
            class="px-4 py-2 bg-accent text-dark hover:bg-accent/90 transition-colors font-sans uppercase tracking-wider text-sm"
          >
            Back to Site
          </a>
        </div>
      </header>
      
      <!-- Messages -->
      {error && (
        <div class="bg-red-900/30 border border-red-500/50 text-red-200 p-4 mb-6">
          <p>{error}</p>
        </div>
      )}
      
      {successMessage && (
        <div class="bg-green-900/30 border border-green-500/50 text-green-200 p-4 mb-6">
          <p>{successMessage}</p>
        </div>
      )}
      
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Form Section -->
        <div class="lg:col-span-1">
          <div class="bg-surface border border-dark p-6 sticky top-8">
            <h2 class="font-serif text-xl text-accent mb-6">
              {editItem ? 'Edit Item' : 'Add New Item'}
            </h2>
            
            <form method="POST" class="space-y-4">
              <input type="hidden" name="action" value={editItem ? 'update' : 'create'} />
              {editItem && <input type="hidden" name="id" value={editItem.id} />}
              
              <div>
                <label class="block text-muted text-sm mb-2 font-sans uppercase tracking-wider text-xs">Title</label>
                <input 
                  type="text" 
                  name="title" 
                  value={editItem?.title || ''}
                  required
                  class="w-full bg-dark border border-dark text-light px-4 py-2 focus:border-accent outline-none transition-colors"
                />
              </div>
              
              <div>
                <label class="block text-muted text-sm mb-2 font-sans uppercase tracking-wider text-xs">Description</label>
                <textarea 
                  name="description" 
                  rows="3"
                  class="w-full bg-dark border border-dark text-light px-4 py-2 focus:border-accent outline-none transition-colors"
                >{editItem?.description || ''}</textarea>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-muted text-sm mb-2 font-sans uppercase tracking-wider text-xs">Price (€)</label>
                  <input 
                    type="number" 
                    name="price" 
                    step="0.01"
                    min="0"
                    value={editItem?.price || ''}
                    required
                    class="w-full bg-dark border border-dark text-light px-4 py-2 focus:border-accent outline-none transition-colors"
                  />
                </div>
                
                <div>
                  <label class="block text-muted text-sm mb-2 font-sans uppercase tracking-wider text-xs">Category</label>
                  <input 
                    type="text" 
                    name="category" 
                    list="categories"
                    value={editItem?.category || ''}
                    required
                    class="w-full bg-dark border border-dark text-light px-4 py-2 focus:border-accent outline-none transition-colors"
                  />
                  <datalist id="categories">
                    {categories.map(cat => (
                      <option value={cat} />
                    ))}
                  </datalist>
                </div>
              </div>
              
              <div>
<label class="block text-muted text-sm mb-2 font-sans uppercase tracking-wider text-xs">Image file</label>
<input 
  type="file" 
  name="imageFile" 
  accept="image/*"
  class="w-full bg-dark border border-dark text-light px-4 py-2 focus:border-accent outline-none transition-colors"
/>
<p class="text-muted/60 text-xs mt-1">Image will be uploaded to Supabase Storage.</p>
              </div>
              
              <div class="flex items-center gap-3 pt-2">
                <input 
                  type="checkbox" 
                  id="sold_out"
                  name="sold_out"
                  checked={editItem?.sold_out || false}
                  class="w-5 h-5 accent-accent bg-dark border-dark rounded"
                />
                <label for="sold_out" class="text-muted font-sans uppercase tracking-wider text-xs">Mark as Sold Out</label>
              </div>
              
              <div class="flex gap-3 pt-4">
                <button 
                  type="submit"
                  class="flex-1 px-4 py-3 bg-accent text-dark hover:bg-accent/90 transition-colors font-sans uppercase tracking-wider text-sm"
                >
                  {editItem ? 'Update Item' : 'Add Item'}
                </button>
                
                {editItem && (
                  <a 
                    href="/admin/menu"
                    class="px-4 py-3 border border-muted text-muted hover:border-light hover:text-light transition-colors font-sans uppercase tracking-wider text-sm"
                  >
                    Cancel
                  </a>
                )}
              </div>
            </form>
          </div>
        </div>
        
        <!-- Menu Items List -->
        <div class="lg:col-span-2">
          {menuItems.length === 0 ? (
            <div class="text-center py-16 bg-surface border border-dark">
              <p class="text-muted text-lg">No menu items yet</p>
              <p class="text-muted/60 text-sm mt-2">Use the form to add your first item</p>
            </div>
          ) : (
            <div class="space-y-4">
              {categories.map(category => {
                const items = menuItems.filter(item => item.category === category)
                return (
                  <div class="bg-surface border border-dark">
                    <div class="p-4 border-b border-dark">
                      <h3 class="font-serif text-lg text-accent uppercase tracking-wider">{category}</h3>
                    </div>
                    <div class="divide-y divide-dark">
                      {items.map(item => (
                        <div class="p-4 flex justify-between items-start gap-4">
                          <div class="flex-1">
                            <div class="flex items-center gap-3 mb-1">
                              <h4 class={`font-medium ${item.sold_out ? 'text-muted line-through' : 'text-light'}`}>
                                {item.title}
                              </h4>
                              {item.sold_out && (
                                <span class="px-2 py-0.5 bg-red-900/30 text-red-400 text-xs font-sans uppercase tracking-wider">
                                  Sold Out
                                </span>
                              )}
                            </div>
                            {item.description && (
                              <p class="text-muted text-sm mb-2">{item.description}</p>
                            )}
                            <p class="text-accent">€{item.price.toFixed(2)}</p>
                          </div>
                          
                          <div class="flex gap-2">
                            <a 
                              href={`/admin/menu?edit=${item.id}`}
                              class="px-3 py-1.5 border border-accent text-accent hover:bg-accent hover:text-dark transition-colors font-sans uppercase tracking-wider text-xs"
                            >
                              Edit
                            </a>
                            <form method="POST" class="inline">
                              <input type="hidden" name="action" value="delete" />
                              <input type="hidden" name="id" value={item.id} />
                              <button 
                                type="submit"
                                onclick="return confirm('Are you sure you want to delete this item?')"
                                class="px-3 py-1.5 border border-red-500/50 text-red-400 hover:bg-red-900/30 transition-colors font-sans uppercase tracking-wider text-xs"
                              >
                                Delete
                              </button>
                            </form>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )
              })}
            </div>
          )}
        </div>
      </div>
    </div>
  </body>
</html>
