---
import Layout from '../layouts/Layout.astro'
---

<Layout title="Checkout | Ravintola K√§skynkk√§">
  <div class="min-h-screen py-32 px-4">
    <div class="max-w-2xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-16">
        <h1 class="font-serif text-4xl md:text-5xl text-accent mb-4">Viimeistele Tilaus</h1>
        <p class="text-muted font-sans tracking-wider uppercase text-sm">Turvallinen maksu Stripen kautta</p>
      </div>
      
      <!-- Order Summary -->
      <div id="order-summary" class="bg-surface p-8 mb-8">
        <h2 class="font-serif text-2xl text-accent mb-6 pb-4 border-b border-dark">Tilauksen Yhteenveto</h2>
        <div id="summary-items" class="space-y-4 mb-6">
          <!-- Items will be populated by JavaScript -->
        </div>
        <div class="flex justify-between items-center pt-6 border-t border-dark">
          <span class="text-muted uppercase tracking-wider text-sm">Yhteens√§</span>
          <span id="summary-total" class="font-serif text-3xl text-accent">‚Ç¨0.00</span>
        </div>
      </div>
      
      <!-- Customer Information -->
      <div class="bg-surface p-8 mb-8">
        <h2 class="font-serif text-2xl text-accent mb-6">Asiakastiedot</h2>
        <form id="checkout-form" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-muted text-sm uppercase tracking-wider mb-2">NIMI (VALINNAINEN)</label>
              <input 
                type="text" 
                id="customer-name"
                placeholder="Sy√∂t√§ nimesi"
                class="w-full bg-dark border border-dark text-light p-4 focus:border-accent focus:outline-none transition-colors"
              />
            </div>
          </div>
        </form>
        <div id="checkout-error" class="hidden mt-6 p-4 bg-red-900/30 border border-red-500/50 text-red-200"></div>
      </div>
      
      <!-- Pickup Information -->
      <div class="bg-surface/50 border border-accent/30 p-6 mb-8">
        <div class="flex items-start gap-4">
          <div class="text-2xl">üìç</div>
          <div>
            <h3 class="font-serif text-xl text-accent mb-2">Vain Nouto</h3>
            <p class="text-light/80 text-sm mb-2">
              Tilaukset ovat vain noutoa varten ravintolastamme.
            </p>
            <p class="text-muted text-sm">
              <strong>Osoite:</strong> Soikkokuja 12, 70780 Kuopio<br>
              <strong>Valmistusaika:</strong> Yleens√§ 20-30 minuuttia<br>
              Saat ilmoituksen kun tilauksesi on valmis!
            </p>
          </div>
        </div>
      </div>
      
      <!-- Checkout Button -->
      <button 
        id="proceed-checkout"
        class="w-full py-6 bg-accent text-dark font-sans font-medium uppercase tracking-widest text-lg hover:bg-accent/90 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed mb-4"
      >
        Siirry maksamaan
      </button>
      
      <!-- Back to Menu -->
      <div class="text-center">
        <a href="/" class="text-muted hover:text-accent transition-colors uppercase tracking-wider text-sm">
          ‚Üê Takaisin Menuun
        </a>
      </div>
    </div>
  </div>
</Layout>

  <script>
  // Get cart items from localStorage (persisted cart)
  const CART_STORAGE_KEY = 'kaskynkka-cart-v1'
  const cartStorageJson = localStorage.getItem(CART_STORAGE_KEY)
  let cartItems: any[] = []
  
  if (cartStorageJson) {
    try {
      const parsed = JSON.parse(cartStorageJson)
      cartItems = Object.values(parsed.items || {})
    } catch (e) {
      console.error('Failed to parse cart:', e)
    }
  }
  
  // Fallback to sessionStorage for backward compatibility
  if (cartItems.length === 0) {
    const sessionCartJson = sessionStorage.getItem('cartItems')
    if (sessionCartJson) {
      try {
        cartItems = JSON.parse(sessionCartJson)
      } catch (e) {
        console.error('Failed to parse session cart:', e)
      }
    }
  }
  
  if (cartItems.length === 0) {
    window.location.href = '/'
  }
  
  // Render order summary
  function renderSummary() {
    const summaryItemsEl = document.getElementById('summary-items')
    const summaryTotalEl = document.getElementById('summary-total')
    
    if (!summaryItemsEl || !summaryTotalEl) return
    
    if (cartItems.length === 0) {
      summaryItemsEl.innerHTML = '<p class="text-muted italic">Ostoskorisi on tyhj√§</p>'
      summaryTotalEl.textContent = '‚Ç¨0.00'
      return
    }
    
    let total = 0
    summaryItemsEl.innerHTML = cartItems.map((item: any) => {
      const itemTotal = item.menuItem.price * item.quantity
      total += itemTotal
      // Normalize title - handle both string and object formats
      let titleStr = ''
      const t = item.menuItem.title
      if (typeof t === 'string') {
        titleStr = t
      } else if (t && typeof t === 'object') {
        titleStr = t.fi || t.en || ''
      }
      return `
        <div class="flex justify-between items-center py-2">
          <div>
            <span class="text-light font-serif">${titleStr}</span>
            <span class="text-muted text-sm ml-2">√ó ${item.quantity}</span>
          </div>
          <span class="text-accent">‚Ç¨${itemTotal.toFixed(2)}</span>
        </div>
      `
    }).join('')
    
    summaryTotalEl.textContent = `‚Ç¨${total.toFixed(2)}`
  }
  
  renderSummary()
  
  // Handle checkout
  document.getElementById('proceed-checkout')?.addEventListener('click', async () => {
    const customerName = (document.getElementById('customer-name') as HTMLInputElement)?.value || ''
    const errorDiv = document.getElementById('checkout-error')
    const button = document.getElementById('proceed-checkout') as HTMLButtonElement
    
    if (!errorDiv || !button) return
    
    button.disabled = true
    button.textContent = 'K√§sitell√§√§n...'
    errorDiv.classList.add('hidden')
    
    try {
      const response = await fetch('/api/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          items: cartItems,
          customerName: customerName,
        }),
      })
      
      // Check if response is JSON
      const contentType = response.headers.get('content-type') || ''
      if (!contentType.includes('application/json')) {
        throw new Error('Palvelin palautti virheellisen vastauksen. Yrit√§ uudelleen.')
      }
      
      const data = await response.json()
      
      if (!response.ok) {
        throw new Error(data.error || 'Tilauksen luominen ep√§onnistui')
      }
      
      if (data.url) {
        window.location.href = data.url
      } else {
        throw new Error('Maksu-URL:aa ei saatu')
      }
    } catch (error: unknown) {
      const message = error instanceof Error ? error.message : 'Tuntematon virhe. Yrit√§ uudelleen.'
      errorDiv.textContent = message
      errorDiv.classList.remove('hidden')
      button.disabled = false
      button.textContent = 'Siirry maksamaan'
    }
  })
  
  // Check for canceled parameter
  const urlParams = new URLSearchParams(window.location.search)
  if (urlParams.get('canceled') === 'true') {
    const errorDiv = document.getElementById('checkout-error')
    if (errorDiv) {
      errorDiv.textContent = 'Maksu peruutettiin. Voit yritt√§√§ uudelleen.'
      errorDiv.classList.remove('hidden')
    }
  }
</script>
