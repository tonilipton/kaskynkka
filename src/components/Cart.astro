---
import { cart, getCartTotal, getCartItemCount, removeFromCart, updateQuantity, clearCart, getCartItems } from '../stores/cart'
---

<div id="cart-container" class="bg-surface p-6 border border-dark">
  <div class="flex justify-between items-center mb-6 pb-4 border-b border-dark">
    <h2 class="font-serif text-2xl text-accent">Tilauksesi</h2>
    <span id="cart-count" class="text-muted text-sm uppercase tracking-wider">0 tuotetta</span>
  </div>
  
  <div id="cart-items" class="min-h-[100px] mb-6">
    <p class="text-center text-muted py-8 italic">Ostoskorisi on tyhjä</p>
  </div>
  
  <div class="border-t border-dark pt-6">
    <div class="text-right mb-6">
      <span class="text-muted text-sm uppercase tracking-wider mr-2">Yhteensä</span>
      <span id="cart-total" class="font-serif text-3xl text-accent">€0.00</span>
    </div>
    
    <button 
      id="checkout-btn" 
      class="w-full py-4 bg-accent text-dark font-sans font-medium uppercase tracking-widest text-sm hover:bg-accent/90 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed mb-3"
      disabled
    >
      Siirry Kassalle
    </button>
    
    <button 
      id="clear-cart-btn"
      class="w-full py-3 border border-muted text-muted font-sans uppercase tracking-widest text-xs hover:border-accent hover:text-accent transition-colors duration-300"
    >
      Tyhjennä Kori
    </button>
  </div>
</div>

<script>
  import { cart, getCartTotal, getCartItemCount, removeFromCart, updateQuantity, clearCart, getCartItems } from '../stores/cart'
  import type { CartItem } from '../stores/cart'
  
  function formatPrice(price: number): string {
    return '€' + price.toFixed(2)
  }
  
  function renderCart(): void {
    const items: CartItem[] = getCartItems()
    const total: number = getCartTotal()
    const count: number = getCartItemCount()
    
    const cartItemsEl = document.getElementById('cart-items')
    const cartTotalEl = document.getElementById('cart-total')
    const cartCountEl = document.getElementById('cart-count')
    const checkoutBtn = document.getElementById('checkout-btn') as HTMLButtonElement | null
    
    if (!cartItemsEl || !cartTotalEl || !cartCountEl || !checkoutBtn) return
    
    cartCountEl.textContent = count + ' ' + (count === 1 ? 'tuote' : 'tuotetta')
    cartTotalEl.textContent = formatPrice(total)
    checkoutBtn.disabled = items.length === 0
    
    if (items.length === 0) {
      cartItemsEl.innerHTML = '<p class="text-center text-muted py-8 italic">Ostoskorisi on tyhjä</p>'
      return
    }
    
    let html = ''
    for (const item of items) {
      html += '<div class="flex justify-between items-center py-4 border-b border-dark/50" data-item-id="' + item.menuItem.id + '">'
      html += '<div class="flex-1">'
      html += '<h4 class="font-serif text-light text-lg">' + item.menuItem.title + '</h4>'
      html += '<p class="text-muted text-sm">' + formatPrice(item.menuItem.price) + ' kpl</p>'
      html += '</div>'
      html += '<div class="flex items-center gap-3">'
      html += '<button class="qty-btn w-8 h-8 flex items-center justify-center border border-muted text-muted hover:border-accent hover:text-accent transition-colors" data-action="decrease" data-item-id="' + item.menuItem.id + '">-</button>'
      html += '<span class="w-8 text-center font-sans text-light">' + item.quantity + '</span>'
      html += '<button class="qty-btn w-8 h-8 flex items-center justify-center border border-muted text-muted hover:border-accent hover:text-accent transition-colors" data-action="increase" data-item-id="' + item.menuItem.id + '">+</button>'
      html += '<button class="remove-btn w-8 h-8 flex items-center justify-center text-muted hover:text-red-400 transition-colors ml-2" data-action="remove" data-item-id="' + item.menuItem.id + '">×</button>'
      html += '</div>'
      html += '<div class="ml-6 text-right min-w-[80px]">'
      html += '<span class="font-serif text-accent text-lg">' + formatPrice(item.menuItem.price * item.quantity) + '</span>'
      html += '</div>'
      html += '</div>'
    }
    cartItemsEl.innerHTML = html
    
    cartItemsEl.querySelectorAll('.qty-btn, .remove-btn').forEach(btn => {
      btn.addEventListener('click', (e: Event) => {
        const target = e.currentTarget as HTMLButtonElement
        const action = target.getAttribute('data-action')
        const itemId = target.getAttribute('data-item-id')
        
        if (!itemId) return
        
        if (action === 'remove') {
          removeFromCart(itemId)
        } else if (action === 'increase') {
          const currentItem = items.find((i: CartItem) => i.menuItem.id === itemId)
          if (currentItem) updateQuantity(itemId, currentItem.quantity + 1)
        } else if (action === 'decrease') {
          const currentItem = items.find((i: CartItem) => i.menuItem.id === itemId)
          if (currentItem) updateQuantity(itemId, currentItem.quantity - 1)
        }
      })
    })
  }
  
  cart.subscribe(() => renderCart())
  renderCart()
  
  document.getElementById('clear-cart-btn')?.addEventListener('click', () => {
    if (confirm('Haluatko varmasti tyhjentää ostoskorin?')) clearCart()
  })
  
  document.getElementById('checkout-btn')?.addEventListener('click', () => {
    window.dispatchEvent(new CustomEvent('checkout', { detail: getCartItems() }))
  })
</script>
