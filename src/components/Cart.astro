---
import { cart, getCartTotal, getCartItemCount, removeFromCart, updateQuantity, clearCart, getCartItems } from '../stores/cart'
import type { Locale } from '../data/menu'
import { t } from '../lib/i18n'

interface Props {
  locale?: Locale
}

const { locale = 'fi' } = Astro.props
---

<div id="cart-container" class="bg-surface border border-dark">
  <div class="flex justify-between items-center p-4 sm:p-6 border-b border-dark">
    <h2 class="font-serif text-2xl text-accent">{locale === 'fi' ? 'Tilauksesi' : 'Your Order'}</h2>
    <span id="cart-count" class="text-muted text-sm uppercase tracking-wider">0</span>
  </div>
  
  <div id="cart-items" class="min-h-[100px] p-4 sm:p-6">
    <p class="text-center text-muted py-8 italic">{t('cart.empty', locale)}</p>
  </div>
  
  <div class="border-t border-dark p-4 sm:p-6">
    <div class="flex justify-between items-center mb-6">
      <span class="text-muted text-sm uppercase tracking-wider">{locale === 'fi' ? 'Yhteensä' : 'Total'}</span>
      <span id="cart-total" class="font-serif text-3xl text-accent">€0.00</span>
    </div>
    
    <button 
      id="checkout-btn" 
      class="w-full py-4 bg-accent text-dark font-sans font-medium uppercase tracking-widest text-sm hover:bg-accent/90 transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed mb-4"
      disabled
      data-locale={locale}
    >
      {locale === 'fi' ? 'Siirry Kassalle' : 'Proceed to Checkout'}
    </button>
    
    <button 
      id="clear-cart-btn"
      class="w-full py-3 border border-muted text-muted font-sans uppercase tracking-widest text-xs hover:border-accent hover:text-accent transition-colors duration-300"
      data-confirm-message={locale === 'fi' ? 'Haluatko varmasti tyhjentää ostoskorin?' : 'Are you sure you want to clear the cart?'}
    >
      {locale === 'fi' ? 'Tyhjennä Kori' : 'Clear Cart'}
    </button>
  </div>
</div>

<script>
  import { cart, getCartTotal, getCartItemCount, removeFromCart, updateQuantity, clearCart, getCartItems } from '../stores/cart'
  import type { CartItem } from '../stores/cart'
  
  function formatPrice(price: number): string {
    return '€' + price.toFixed(2)
  }
  
  function renderCart(): void {
    const items: CartItem[] = getCartItems()
    const total: number = getCartTotal()
    const count: number = getCartItemCount()
    
    const cartItemsEl = document.getElementById('cart-items')
    const cartTotalEl = document.getElementById('cart-total')
    const cartCountEl = document.getElementById('cart-count')
    const checkoutBtn = document.getElementById('checkout-btn') as HTMLButtonElement | null
    
    // Get locale from the button or default to fi
    let locale = 'fi'
    if (checkoutBtn) {
      locale = checkoutBtn.getAttribute('data-locale') || 'fi'
    } else {
      // Fallback: check body or html element
      const htmlEl = document.querySelector('html')
      if (htmlEl?.getAttribute('lang') === 'en') locale = 'en'
    }
    
    const itemText = locale === 'fi' ? 'tuote' : 'items'
    const itemTextSingular = locale === 'fi' ? 'tuote' : 'item'
    const emptyText = locale === 'fi' ? 'Ostoskorisi on tyhjä' : 'Your cart is empty'
    const perPiece = locale === 'fi' ? 'kpl' : 'pc'
    
    if (cartCountEl) cartCountEl.textContent = count + ' ' + (count === 1 ? itemTextSingular : itemText)
    if (cartTotalEl) cartTotalEl.textContent = formatPrice(total)
    if (checkoutBtn) checkoutBtn.disabled = items.length === 0
    
    if (!cartItemsEl) return
    
    if (items.length === 0) {
      cartItemsEl.innerHTML = '<p class="text-center text-muted py-8 italic">' + emptyText + '</p>'
      return
    }
    
    let html = ''
    for (const item of items) {
      // Normalize title for both string and object-with-locales formats
      let titleStr = ''
      const t = item.menuItem.title
      if (typeof t === 'string') {
        titleStr = t
      } else if (t && typeof t === 'object') {
        titleStr = t[locale as 'fi' | 'en'] ?? t.fi ?? ''
      }
      
      html += '<div class="flex justify-between items-center py-4 border-b border-dark/50 last:border-b-0" data-item-id="' + (item.menuItem.id ?? '') + '">'
      html += '<div class="flex-1 min-w-0">'
      html += '<h4 class="font-serif text-light text-lg truncate">' + titleStr + '</h4>'
      html += '<p class="text-muted text-sm">' + formatPrice(item.menuItem.price) + ' ' + perPiece + '</p>'
      html += '</div>'
      html += '<div class="flex items-center gap-2 flex-shrink-0 ml-4">'
      html += '<button class="qty-btn w-8 h-8 flex items-center justify-center border border-muted text-muted hover:border-accent hover:text-accent transition-colors" data-action="decrease" data-item-id="' + item.menuItem.id + '">-</button>'
      html += '<span class="w-8 text-center font-sans text-light">' + item.quantity + '</span>'
      html += '<button class="qty-btn w-8 h-8 flex items-center justify-center border border-muted text-muted hover:border-accent hover:text-accent transition-colors" data-action="increase" data-item-id="' + item.menuItem.id + '">+</button>'
      html += '<button class="remove-btn w-8 h-8 flex items-center justify-center text-muted hover:text-red-400 transition-colors" data-action="remove" data-item-id="' + item.menuItem.id + '">×</button>'
      html += '</div>'
      html += '<div class="text-right min-w-[70px] ml-4">'
      html += '<span class="font-serif text-accent text-lg">' + formatPrice(item.menuItem.price * item.quantity) + '</span>'
      html += '</div>'
      html += '</div>'
    }
    cartItemsEl.innerHTML = html
    
    cartItemsEl.querySelectorAll('.qty-btn, .remove-btn').forEach(btn => {
      btn.addEventListener('click', (e: Event) => {
        const target = e.currentTarget as HTMLButtonElement
        const action = target.getAttribute('data-action')
        const itemId = target.getAttribute('data-item-id')
        
        if (!itemId) return
        
        if (action === 'remove') {
          removeFromCart(itemId)
        } else if (action === 'increase') {
          const currentItem = items.find((i: CartItem) => i.menuItem.id === itemId)
          if (currentItem) updateQuantity(itemId, currentItem.quantity + 1)
        } else if (action === 'decrease') {
          const currentItem = items.find((i: CartItem) => i.menuItem.id === itemId)
          if (currentItem) updateQuantity(itemId, currentItem.quantity - 1)
        }
      })
    })
  }
  
  cart.subscribe(() => renderCart())
  renderCart()
  
  document.getElementById('clear-cart-btn')?.addEventListener('click', (e) => {
    const btn = e.currentTarget as HTMLButtonElement
    const confirmMessage = btn.getAttribute('data-confirm-message') || 'Are you sure?'
    if (confirm(confirmMessage)) clearCart()
  })
  
  document.getElementById('checkout-btn')?.addEventListener('click', () => {
    window.dispatchEvent(new CustomEvent('checkout', { detail: getCartItems() }))
  })
</script>
